library(BBmisc)
library(batchtools)
library(checkmate)
library(dplyr)

# generated by filter_benchmark_tuning.R
load("../Results/results_tuning.RData")
load("../Results/data_info.RData")
source("stability_measure.R")

reg.dir = choose.dir()
loadRegistry(reg.dir, writeable = TRUE, work.dir = getwd())

# only the datasets that finished in time
nrs = c(2, 4, 5, 6, 7, 8, 10, 11, 13, 14, 15, 16, 17, 18, 20, 21)
all = unwrap(getJobTable(findDone()))
all = all[nr %in% nrs & algorithm == "filter", ]

data.info.original = data.info
data.info = data.info[nrs, ]
new.order = order(data.info$n.feats)



#################################################################################
# stability of tuned configurations

fun.feats = function(job, res) {
  data.table(
    algo.name = job$algo.name,
    prob.name = job$prob.name,
    algo.pars = list(job$algo.pars),
    prob.pars = list(job$prob.pars),
    repl = job$repl,
    hyperpars = list(res$pars),
    features.outer = list(res$res$features.outer)
  )
}

reduce.and.aggregate.stability = function(ids) {
  red.ids = findDone(ids)

  # for intermediate analyses while jobs are still running on cluster
  exist.ids = file.exists(paste0(reg.dir, "/results/", red.ids$job.id, ".rds"))
  red.ids = red.ids[exist.ids, ]

  res = reduceResultsDataTable(red.ids, fun = fun.feats)

  unwrap.cols = c("algo.pars", "prob.pars")
  res2 = bind_rows(res$result)
  res3 = unwrap(res2, cols = unwrap.cols)

  res4 = merge(res3, data.table(nr = 1:nrow(data.info.original),
    n.feats = data.info.original$n.feats, dataname = data.info.original$name),
    by = "nr")

  stab.fun = function(features, p) {
    if (min(lengths(features)) == 0) {
      return(NA_real_)
    } else {
      return(SC(features, p))
    }
  }

  results = res4[, list(stability = stab.fun(features = features.outer, p = unique(n.feats))),
    by = c("fw.method", "dataname")]

  results$dataname = droplevels(factor(results$dataname,
    levels = data.info$name[new.order]))

  return(results)
}


tmp = merge(all, results.tuned, by = intersect(colnames(all), colnames(results.tuned)))
results.stability = reduce.and.aggregate.stability(tmp$job.id)
save(results.stability, file = "../Results/results_stability.RData")

