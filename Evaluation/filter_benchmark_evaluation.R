library(ggplot2)
library(data.table)
library(mco)

# generated by filter_benchmark_tuning.R
load("../Results/results_tuning.RData")

# generated in filter_benchmark_rank_cors.R
load("mean_cor.RData")


# make the minimum 0
s0 = function(x) {
  return(x - min(x, na.rm = TRUE))
}

s1 = function(x) {
  return(max(x, na.rm = TRUE) - x)
}

s01 = function(x) {
  min = min(x, na.rm = TRUE)
  max = max(x, na.rm = TRUE)
  if (max == min) {
    res = rep(0, length(x))
  } else {
    res = (x - min) / (max - min)
  }
  return(res)
}


# symbols for plotting
n.methods = length(unique(results.tuned$fw.method))
syms.basic = c(0:2, 4:6, 8, 11, 13, 14)
syms = rep(syms.basic, ceiling(n.methods / length(syms.basic)))
na.sym = 17


# use accuracy instead of mmce
results.tuned.aggr$mmce.outer.mean = 1 - results.tuned.aggr$mmce.outer.mean
results.tuned$mmce.outer = 1 - results.tuned$mmce.outer


# rename filters
rename.filters = function(n) {
  n2 = strsplit(n, "FSelectorRcpp.")
  n2a = unlist(lapply(n2, function(x) x[length(x)]))

  n3 = strsplit(n2a, "praznik.")
  n3a = unlist(lapply(n3, function(x) x[length(x)]))

  n4 = strsplit(n3a, "ranger.")
  n4a = unlist(lapply(n4, function(x) x[length(x)]))

  n5 = ifelse(n4a == "gainratio", "gain.ratio", n4a)
  n5 = ifelse(n5 == "infogain", "info.gain", n5)
  n5 = ifelse(n5 == "symuncert", "sym.uncert", n5)

  return(n5)
}

results.tuned$fw.method = rename.filters(results.tuned$fw.method)
results.tuned$fw.method = factor(results.tuned$fw.method, levels = colnames(mean.cor$mean.cors)[mean.cor$o])

results.tuned.aggr$fw.method = rename.filters(results.tuned.aggr$fw.method)
results.tuned.aggr$fw.method = factor(results.tuned.aggr$fw.method, levels = colnames(mean.cor$mean.cors)[mean.cor$o])


##########################################################################################
# mmce and time per dataset

pdf("../Plots/mmce_time_dataset.pdf", width = 12)
gg = ggplot(data = results.tuned.aggr,
  mapping = aes(x = mmce.outer.mean, y = timetrain.outer.median, color = fw.method, shape = fw.method)) +
  geom_point() +
  facet_wrap("dataname", nrow = 4, scales = "free") +
  scale_shape_manual(values = syms, na.value = na.sym, drop = FALSE, guide = guide_legend(ncol = 7)) +
  scale_y_log10() +
  theme(legend.position = "bottom") +
  ylab("Run time (in seconds)") +
  xlab("Mean accuracy")
print(gg)
dev.off()


scaleFUN = function(x) {
  sprintf("%.3f", x)
}

pdf("../Plots/mmce_time_filter_dataset.pdf", width = 14, height = 10)
gg = ggplot(data = results.tuned.aggr,
  mapping = aes(x = mmce.outer.mean, y = time.filter.outer.median, color = fw.method, shape = fw.method)) +
  theme_bw() +
  geom_point(size = 2, stroke = 1) +
  facet_wrap("dataname", nrow = 4, scales = "free") +
  scale_shape_manual(values = syms, na.value = na.sym, drop = FALSE,
    guide = guide_legend(ncol = 4), name = "Filter method") +
  scale_color_discrete(name = "Filter method") +
  theme(legend.position = "bottom",
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 13),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 13),
    strip.text = element_text(size = 13),
    legend.spacing.x = unit(2, "line"),
    plot.margin = unit(c(5.5, 8.5, 5.5, 2.5), "pt")) +
  ylab("Median run time for filtering (in seconds)") +
  xlab("Mean accuracy") +
  scale_x_continuous(labels = scaleFUN)
print(gg)
dev.off()


#########################################################################################
# mmce only

res.tuned = results.tuned
o = mean.cor$o
names.o = colnames(mean.cor$mean.cors)[o]
res.tuned$fw.method = droplevels(factor(res.tuned$fw.method,
  levels = names.o))

rts = split(res.tuned, res.tuned$dataname)
pdf("../Plots/mmces.pdf")
for (rtsi in rts) {
  gg = ggplot(data = rtsi,
    mapping = aes(y = mmce.outer, x = fw.method)) +
    theme_bw() +
    geom_boxplot() +
    labs(title = rtsi$dataname[1]) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
      axis.text = element_text(size = 13),
      axis.title = element_text(size = 13.5),
      plot.title = element_text(size = 13)) +
    xlab("Filter method") +
    ylab("Accuracy")
  print(gg)
}
dev.off()

##########################################################################
# aggregate over datasets


# scale before aggregation
rfs = results.tuned.aggr[, list(
  mmce.outer.mean = s1(mmce.outer.mean),
  log.timetrain.outer.median = s0(log10(timetrain.outer.median)),
  time.filter.outer.median = time.filter.outer.median,
  fw.method = fw.method,
  algo.name = algo.name),
  by = "dataname"]


rfs.aggr = rfs[, list(
  mmce.median = median(mmce.outer.mean),
  log.time.median = median(log.timetrain.outer.median),
  time.filter.median = median(time.filter.outer.median),
  mmce.q25 = quantile(mmce.outer.mean, 0.25, type = 2),
  mmce.q75 = quantile(mmce.outer.mean, 0.75, type = 2),
  time.q25 = quantile(log.timetrain.outer.median, 0.25, type = 2),
  time.q75 = quantile(log.timetrain.outer.median, 0.75, type = 2),
  time.filter.q25 = quantile(time.filter.outer.median, 0.25, type = 2),
  time.filter.q75 = quantile(time.filter.outer.median, 0.75, type = 2)
), by = "fw.method"]



pdf("../Plots/mmce_time_all.pdf", width = 10, height = 6.5)
gg = ggplot(data = rfs.aggr,
  mapping = aes(x = mmce.median, y = log.time.median, color = fw.method, shape = fw.method)) +
  theme_bw() +
  geom_errorbar(aes(ymin = time.q25, ymax = time.q75), size = 0.5) +
  geom_errorbarh(aes(xmin = mmce.q25, xmax = mmce.q75), size = 0.5) +
  geom_point(size = 3, stroke = 1.5) +
  scale_shape_manual(values = syms, na.value = na.sym, drop = FALSE, name = "Filter method",
    guide = guide_legend(ncol = 1)) +
  scale_color_discrete(drop = FALSE, name = "Filter method") +
  xlab("Relative mean accuracy") +
  ylab("Relative logarithmic median run time") +
  theme(axis.text = element_text(size = 12),
    axis.title = element_text(size = 12.5),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12))
print(gg)
dev.off()

# Pareto optimal: entire run time
x = paretoFilter(as.matrix(rfs.aggr[, c("mmce.median", "log.time.median")]))
merge(x, rfs.aggr)

x = paretoFilter(as.matrix(rfs.aggr[, c("mmce.q75", "log.time.median")]))
merge(x, rfs.aggr)



pdf("../Plots/mmce_time_filter_all1.pdf", width = 9, height = 6.5)
gg = ggplot(data = rfs.aggr,
  mapping = aes(x = mmce.median, y = time.filter.median, color = fw.method, shape = fw.method)) +
  theme_bw() +
  geom_errorbarh(aes(xmin = mmce.q25, xmax = mmce.q75), size = 0.5) +
  geom_point(size = 3, stroke = 1.5) +
  scale_shape_manual(values = syms, na.value = na.sym, drop = FALSE, name = "Filter method",
    guide = guide_legend(ncol = 1)) +
  scale_color_discrete(drop = FALSE, name = "Filter method") +
  xlab("Relative mean accuracy") +
  ylab("Median run time for filtering (in seconds)") +
  theme(axis.text = element_text(size = 14),
    axis.title = element_text(size = 15.5),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 13)) +
  ylim(0, 40)
print(gg)
dev.off()
pdf("../Plots/mmce_time_filter_all2.pdf", width = 6, height = 6.5)
gg = ggplot(data = rfs.aggr,
  mapping = aes(x = mmce.median, y = time.filter.median, color = fw.method, shape = fw.method)) +
  theme_bw() +
  geom_errorbar(aes(ymin = time.filter.q25, ymax = time.filter.q75), size = 0.5) +
  geom_errorbarh(aes(xmin = mmce.q25, xmax = mmce.q75), size = 0.5) +
  geom_point(size = 3, stroke = 1.5) +
  scale_shape_manual(values = syms, na.value = na.sym, drop = FALSE, name = "Filter method",
    guide = FALSE) +
  scale_color_discrete(drop = FALSE, name = "Filter method", guide = FALSE) +
  xlab("Relative mean accuracy") +
  ylab("Median run time for filtering (in seconds)") +
  theme(axis.text = element_text(size = 14),
    axis.title = element_text(size = 15.5),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 13))
print(gg)
dev.off()


# Pareto optimal: time for filtering
x = paretoFilter(as.matrix(rfs.aggr[, c("mmce.median", "time.filter.median")]))
merge(x, rfs.aggr)

x = paretoFilter(as.matrix(rfs.aggr[, c("mmce.q75", "time.filter.median")]))
merge(x, rfs.aggr)



############################################################################

dominated = function(x1, x2) {
  (x1 > x2) + 0.5 * (x1 == x2)
}

dom.matrix = function(mmce) {
  mat = matrix(0L, ncol = n.methods, nrow = n.methods)
  for (i in 1:n.methods) {
    for (j in setdiff(1:n.methods, i)) {
      mat[i, j] = dominated(mmce[i], mmce[j])
    }
  }
  return(mat)
}

domin = results.tuned.aggr[, list(dom.mat = list(dom.matrix(mmce.outer.mean))), by = c("dataname")]

dom.mats = domin$dom.mat
n.dominated = dom.mats[[1]]
for (i in 2:16) {
  n.dominated = n.dominated + dom.mats[[i]]
}

rownames(n.dominated) = colnames(n.dominated) = results.tuned.aggr[dataname == "chin", ]$fw.method
name.na = which(is.na(colnames(n.dominated)))
rownames(n.dominated)[name.na] = colnames(n.dominated)[name.na] = "NA"
n.dominated

# times dominated by others
sort(colSums(n.dominated))

# times dominating others
sort(rowSums(n.dominated), decreasing = TRUE)

times.d = data.frame(dominating = rowSums(n.dominated), dominated = colSums(n.dominated))
o = order(times.d$dominating, decreasing = TRUE)
times.d = times.d[o, ]

plot_mat2 = function(dat, names, title = "") {
  colnames(dat) = rownames(dat) = names
  plt.data = cbind(measure = names, as.data.frame(dat))
  plt.data = melt(plt.data, id.vars = "measure")
  plt.data$measure = factor(plt.data$measure, levels = names)
  plt.data$variable = factor(plt.data$variable, levels = names)

  gg = ggplot(plt.data, aes(measure, variable)) +
    geom_tile(aes(fill = value), colour = "white") +
    scale_fill_gradient2(low = "darkblue", mid = "white", high = "darkred", name = "Times",
      limits = c(0, 16), midpoint = 8) +
    geom_text(aes(label = value, color = abs(value - 8) >= 5), size = 5) +
    scale_color_manual(guide = FALSE, values = c("black", "white")) +
    theme_grey() +
    labs(x = "", y = "", title = title) +
    scale_x_discrete(expand = c(0, 0), labels = names) +
    scale_y_discrete(expand = c(0, 0), labels = names) +
    theme(axis.ticks = element_blank()) +
    coord_equal(ratio = 0.5) +
    xlab("Losses") +
    ylab("Wins") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
      axis.text = element_text(size = 12),
      axis.title = element_text(size = 12),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12))

  print(gg)
  invisible(NULL)
}

dom.n = names(sort(rowSums(n.dominated), decreasing = FALSE))
dom.o = n.dominated[dom.n, dom.n]
diag(dom.o) = NA

pdf("../Plots/better_accuracy.pdf", width = 11.5, height = 7)
plot_mat2(t(dom.o), dom.n)
dev.off()

